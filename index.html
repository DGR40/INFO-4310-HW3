<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>INFO 4310 HW 3</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        display: inline-block;
        font-family: "Work Sans", san-serif;
      }

      .header {
        background-color: #fb4d42;
        color: white;
        box-shadow: rgba(0, 0, 0, 0.2) 0px 10px 20px;
        padding: 10px;
        margin-bottom: 10px;
        text-align: center;
        height: 10vh;
      }

      .filter {
        height: fit-content;
        width: fit-content;
        background-color: white;
        padding: 10;
        cursor: pointer;
        border-radius: 4px;
        margin: 5px;
        transition: background-color 0.3s ease;
        border: 1px solid black;
      }

      .filter:hover {
        background-color: #fb4d42;
        color: white;
      }

      .selected:hover {
        background-color: #fb4d42;
      }

      .selected {
        background-color: #fb4d42;
        color: white;
      }

      #filter-area {
        background-color: #f7f9fa;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        height: 60vh;
        float: left;
        box-shadow: rgba(0, 0, 0, 0.2) 0px 10px 20px;
      }

      .allOrClearButton {
        display: flex;
        flex-direction: row;
        height: fit-content;
        cursor: pointer;
        margin: 5;
        border-radius: 4px;
        border: 1px solid black;
        background-color: white;
        font-weight: 800;
      }

      .inner {
        flex: 1;
        padding: 10;
        transition: background-color 0.3s ease;
      }

      .inner:hover {
        background-color: #fb4d42;
        color: white;
      }

      .allButton {
        border-right: 1px solid grey;
      }

      #map {
        margin-left: 10px;
        background-color: white;
        box-shadow: rgba(0, 0, 0, 0.2) 0px 10px 30px;
        padding: 5px;
      }

      #inspector {
        height: 60vh;
        color: black;
        margin-left: 10px;
        box-shadow: rgba(0, 0, 0, 0.2) 0px 10px 30px;
        background-color: #f7f9fa;
      }

      .title {
        margin: 10px;
        border-bottom: solid 1px grey;
        color: black;
      }
      .zip-outline {
        fill: none;
      }
      .zip {
        padding-top: 5px;
      }
    </style>
  </head>

  <body>
    <div class="header"><h1>Eat Boston, Eat Better</h1></div>
    <div style="display: flex; flex-direction: row">
      <div id="filter-area" style="width: 25vw">
        <h2 class="title">Select what cuisine you are feeling:</h2>
      </div>
      <svg id="map" height="85vh" width="45vw"></svg>
      <div id="inspector" style="width: 27vw">
        <h2 class="title">Click on a restaurant to view it's details...</h2>
        <div class="info" style="padding-left: 10px">
          <p id="name">Name:</p>
          <p id="rating">Rating:</p>
          <p id="neighborhood">Neighborhood:</p>
          <p id="review">Sample Review:</p>
        </div>
      </div>
    </div>
  </body>

  <script>
    let searchCategory = [
      "bakeries",
      "cafes",
      "chinese",
      "coffee",
      "donuts",
      "ethnicmarkets",
      "french",
      "indpak",
      "italian",
      "japanese",
      "mexican",
      "newamerican",
      "pizza",
      "restaurants",
      "sandwiches",
      "sushi",
      "thai",
      "vietnamese",
    ];

    function makeFilters() {
      let filter = document.getElementById("filter-area");
      for (let i = 0; i < searchCategory.length; i++) {
        let filterName = searchCategory[i];
        let formattedFilterName = "";
        if (filterName == "indpak") {
          formattedFilterName = "Indian Pakistani";
        } else if (filterName == "ethnicmarkets") {
          formattedFilterName = "Ethnic Markets";
        } else if (filterName == "newamerican") {
          formattedFilterName = "American";
        } else {
          formattedFilterName =
            filterName.charAt(0).toUpperCase() + filterName.substring(1);
        }
        filter.innerHTML += `<div class="filter" id="${searchCategory[i]}">${formattedFilterName}</div>`;
      }
      filter.innerHTML +=
        `<br />` +
        `<div class="allOrClearButton">` +
        `<div id="select" class="inner allButton">All</div>` +
        ` <div id="clear" class="inner">Clear</div> </div>`;
    }
    makeFilters();


    let map = d3.select("#map");
    let dimensions = map.node().getBoundingClientRect();
    let mapWidth = dimensions.width;
    let mapHeight = dimensions.height;
    const viewport = map.append("g").attr("class", "viewport");

    const requestData = async function () {
      var activeFilters = [];

      var reviews = await d3.csv("yelp_boston.csv", d3.autoType);
      reviews = reviews.filter( d => (d["neighborhood"]!== null));
      console.log(reviews);
      let bostonGeo = await d3.json("boston_zipcodes.topo.json");

      const zipsMesh = topojson.mesh(bostonGeo, bostonGeo.objects.collection);
      var projection = d3.geoMercator().fitSize([mapWidth - 10, mapHeight - 10], zipsMesh);
      var path = d3.geoPath().projection(projection);


      viewport.append("path")
              .datum(zipsMesh)
              .attr("class", "zip-outline")
              .attr("d", path)
              .style("stroke-width", 1)
              .style("stroke", "grey");

       // landmarks in order (fenway park, )
      let fenway = projection([-71.0972,42.3467]);
      let faneuil = projection([-71.0551, 42.3602]);
      let commons = projection([-71.0657 ,42.3551])
      var sym = d3.symbol().type(d3.symbolStar);

      viewport.append("path").datum(fenway)
              .attr("class", "star")
              .attr("d", sym)
              .attr("fill", "gold")
              .attr("transform", d => `translate(${d[0]},${d[1]})`)
      viewport.append("path").datum(faneuil)
              .attr("class", "star")
              .attr("d", sym)
              .attr("fill", "gold")
              .attr("transform", d => `translate(${d[0]},${d[1]})`)
      viewport.append("path").datum(commons)
              .attr("class", "star")
              .attr("d", sym)
              .attr("fill", "gold")
              .attr("transform", d => `translate(${d[0]},${d[1]})`)    
      
      
      var zoom = d3.zoom()
                  .scaleExtent([1,10])
                  .on("zoom", mapZoomed);

      map.call(zoom);

      reviews.forEach((d) => {
          d.position = projection([d.longitude, d.latitude]);
      });

      function mapZoomed(event) {
          viewport.attr("transform", event.transform.toString());
          viewport.select(".zip-outline")
                  .style("stroke-width", 1 / event.transform.k);
          circles.attr("r", 5 / event.transform.k).style("stroke-width", 1 / event.transform.k)
      };

      let clear_button = d3.select("#clear").on("click", clear);
      let all_button = d3.select("#select").on("click", all);
      let filters = d3.selectAll("div.filter").on("click", addFilter);
      
      function clear() {
        console.log("clear")
        let filter_input = [];
        let activeFilters = filter_input;

        updatePoints(filter_input, reviews);
      }
      function all() {
        console.log("all")
        let filter_input = searchCategory;
        let activeFilters = filter_input;

        updatePoints(filter_input, reviews);
      }
      function addFilter() {
        console.log("filter")
        console.log("other function", activeFilters)
        
      }

      updatePoints(searchCategory, reviews);


      function updatePoints(filters, data) {
        // this won't change the activeFilters variable up top 
        let activeFilters = filters;
        console.log("activeFilters variable", activeFilters)
        data = data.filter( d => filters.includes(d["search category"]) ); 

        viewport
          .selectAll("circle.datapoint")
          .data(data)
          .join("circle")
          .attr("class", "datapoint")
          .attr("r", 5)
          .attr("cx", (d) => d.position[0])
          .attr("cy", (d) => d.position[1])
          .attr("fill", (d) => findFill(d.rating))
          .attr("stroke", "black")
          .attr("stroke-width", 1)
          .on("mouseover", mouseOver)
          .on("mouseout", mouseOut);
        
          function mouseOver(event, d) {
            console.log("mouseover!!");
            let point = d3.select(this);

            let name = document.getElementById("name");
            let rating = document.getElementById("rating");
            let neighborhood = document.getElementById("neighborhood");
            let review = document.getElementById("review");
            point.attr("fill", "red").attr("r", 8);

            name.textContent = "Name: " + d.name;
            rating.textContent = "Rating: " + d.rating;
            neighborhood.textContent = "Neighborhood: " + d.neighborhood;
            review.textContent = "Sample Review: " + d.snippet_text;
          }

          function mouseOut(event, d){
            let point = d3.select(this);
            let name = document.getElementById("name");
            let rating = document.getElementById("rating");
            let neighborhood = document.getElementById("neighborhood");
            let review = document.getElementById("review");
            point.attr("fill", (d) => findFill(d.rating)).attr("r", 5)

            name.textContent = "Name: ";
            rating.textContent = "Rating: ";
            neighborhood.textContent = "Neighborhood: ";
            review.textContent = "Sample Review: ";
          }
      };


    }

    function findFill(rating) {
      if (rating >= 4.5) {
        return "#7ABD7E";
      } else if (rating > 3.5 && rating < 4.5) {
        return "#FFB54C";
      } else {
        return "#FF6961";
      }
    }

    // function toggleFilter(elt) {
    //   console.log(elt);
    //   let filter = elt.id;
    //   if (!activeFilters.includes(filter)) {
    //     activeFilters.push(filter);
    //     updatePoints(reviews);
    //   } 
    //   else {
    //     let targetIndex = activeFilters.indexOf(filter);
    //     activeFilters.splice(targetIndex, 1);
    //     updatePoints(reviews);
    //   }
    //   let classes = elt.classList;
    //   classes.toggle("selected");
    // }


    requestData();
  </script>
</html>
