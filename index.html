<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>INFO 4310 HW 3</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        display: inline-block;
        font-family: "Work Sans", san-serif;
      }

      .header {
        background-color: #fb4d42;
        color: white;
        box-shadow: rgba(0, 0, 0, 0.2) 0px 10px 20px;
        padding: 10px;
        margin-bottom: 10px;
        text-align: center;
        height: 10vh;
      }

      .filter {
        height: fit-content;
        width: fit-content;
        background-color: white;
        padding: 10;
        cursor: pointer;
        border-radius: 4px;
        margin: 5px;
        transition: background-color 0.3s ease;
        border: 1px solid black;
      }

      .filter:hover {
        background-color: #fb4d42;
        color: white;
      }

      .selected:hover {
        background-color: #fb4d42;
      }

      .selected {
        background-color: #fb4d42;
        color: white;
      }

      #filter-area {
        background-color: #f7f9fa;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        height: 60vh;
        float: left;
        box-shadow: rgba(0, 0, 0, 0.2) 0px 10px 20px;
      }

      .allOrClearButton {
        display: flex;
        flex-direction: row;
        height: fit-content;
        cursor: pointer;
        margin: 5;
        border-radius: 4px;
        border: 1px solid black;
        background-color: white;
        font-weight: 800;
      }

      .inner {
        flex: 1;
        padding: 10;
        transition: background-color 0.3s ease;
      }

      .inner:hover {
        background-color: #fb4d42;
        color: white;
      }

      .allButton {
        border-right: 1px solid grey;
      }

      #map {
        margin-left: 10px;
        background-color: white;
        box-shadow: rgba(0, 0, 0, 0.2) 0px 10px 30px;
        padding: 5px;
      }

      #inspector {
        height: 60vh;
        color: black;
        margin-left: 10px;
        box-shadow: rgba(0, 0, 0, 0.2) 0px 10px 30px;
        background-color: #f7f9fa;
      }

      .title {
        margin: 10px;
        border-bottom: solid 1px grey;
        color: black;
      }
      .zip-outline {
        fill: none;
      }
      .zip {
        padding-top: 5px;
      }
    </style>
  </head>

  <body>
    <div class="header"><h1>Eat Boston, Eat Better</h1></div>
    <div style="display: flex; flex-direction: row">
      <div id="filter-area" style="width: 25vw">
        <h2 class="title">Select what cuisine you are feeling:</h2>
      </div>
      <svg id="map" height="85vh" width="45vw"></svg>
      <div id="inspector" style="width: 27vw">
        <h2 class="title">Select a restaurant to view it's details...</h2>
        <div class="info" style="padding-left: 10px">
          <p id="name">Name:</p>
          <p id="rating">Rating:</p>
          <p id="neighborhood">Neighborhood:</p>
          <p id="review">Sample Review:</p>
        </div>
      </div>
    </div>
  </body>

  <script>
    let REVIEWS = [];
    let activeFilters = [];
    let searchCategory = [
      "bakeries",
      "cafes",
      "chinese",
      "coffee",
      "donuts",
      "ethnicmarkets",
      "french",
      "indpak",
      "italian",
      "japanese",
      "mexican",
      "newamerican",
      "pizza",
      "restaurants",
      "sandwiches",
      "sushi",
      "thai",
      "vietnamese",
    ];

    function makeFilters() {
      let filter = document.getElementById("filter-area");
      for (let i = 0; i < searchCategory.length; i++) {
        let filterName = searchCategory[i];
        let formattedFilterName = "";
        if (filterName == "indpak") {
          formattedFilterName = "Indian Pakistani";
        } else if (filterName == "ethnicmarkets") {
          formattedFilterName = "Ethnic Markets";
        } else if (filterName == "newamerican") {
          formattedFilterName = "American";
        } else {
          formattedFilterName =
            filterName.charAt(0).toUpperCase() + filterName.substring(1);
        }
        filter.innerHTML += `<div class="filter" id="${searchCategory[i]}" onClick="toggleFilter(this)">${formattedFilterName}</div>`;
      }
      filter.innerHTML +=
        `<br />` +
        `<div class="allOrClearButton">` +
        `<div class="inner allButton" onclick="selectAll()">All</div>` +
        ` <div class="inner" onclick="clearAll()">Clear</div> </div>`;
    }

    let map = d3.select("#map");
    let dimensions = map.node().getBoundingClientRect();
    let mapWidth = dimensions.width;
    let mapHeight = dimensions.height;
    const viewport = map.append("g").attr("class", "viewport");

    let PATH = "";
    let PROJECTION = "";

    const requestData = async function () {
      let reviews = await d3.csv("yelp_boston.csv", d3.autoType);
      REVIEWS = reviews;
      let bostonGeo = await d3.json("boston_zipcodes.topo.json");
      console.log(reviews);
      console.log(bostonGeo);

      const zips = topojson.feature(bostonGeo, bostonGeo.objects.collection);
      const zipsMesh = topojson.mesh(bostonGeo, bostonGeo.objects.collection);
      var projection = d3
        .geoMercator()
        .fitSize([mapWidth - 10, mapHeight - 10], zipsMesh);
      PROJECTION = projection;
      var path = d3.geoPath().projection(projection);
      PATH = path;

      console.log(zips);
      console.log(zipsMesh);

      let zipPaths = viewport
        .selectAll("path.zip")
        .data(zips.features)
        .join("path")
        .attr("class", "zip")
        .attr("d", path)
        .style("fill", "none");

      viewport
        .append("path")
        .datum(zipsMesh)
        .attr("class", "zip-outline")
        .attr("d", path)
        .style("stroke-width", 1)
        .style("stroke", "grey");

      let filteredReviews = [];

      reviews.forEach((d) => {
        let searchCategory = d["search category"];
        if (
          activeFilters.includes(d["search category"]) &&
          d["neighborhood"] !== null
        ) {
          d.position = projection([d.longitude, d.latitude]);
          filteredReviews.push(d);
        }
      });

      let circles = viewport
        .selectAll("circle.datapoint")
        .data(filteredReviews)
        .join("circle")
        .attr("class", (d) => `datapoint ${d["search category"]}`)
        .attr("r", 5)
        .attr("cx", (d) => d.position[0])
        .attr("cy", (d) => d.position[1])
        .attr("fill", (d) => findFill(d.rating))
        .attr("stroke", "black")
        .on("mouseover", mouseOver)
        .on("mouseout", mouseOut);
    };

    function findFill(rating) {
      if (rating >= 4.5) {
        return "#7ABD7E";
      } else if (rating > 3.5 && rating < 4.5) {
        return "#FFB54C";
      } else {
        return "#FF6961";
      }
    }

    function clearCircles(category = null) {
      if (category) {
        d3.selectAll(`circle.datapoint.${category}`).remove();
      } else {
        d3.selectAll(`circle.datapoint`).remove();
      }
    }

    function toggleFilter(elt) {
      let filter = elt.id;
      if (!activeFilters.includes(filter)) {
        activeFilters.push(filter);
        requestData();
      } else {
        clearCircles(filter);
        let targetIndex = activeFilters.indexOf(filter);
        activeFilters.splice(targetIndex, 1);
      }
      let classes = elt.classList;
      classes.toggle("selected");
    }

    function selectAll() {
      let allFilters = Array.from(document.getElementsByClassName("filter"));
      allFilters.forEach((f) => {
        f.classList = "filter selected";
        let filter = f.id;
        if (activeFilters.includes(filter)) {
          let targetIndex = activeFilters.indexOf(filter);
          activeFilters.splice(targetIndex, 1);
        } else {
          activeFilters.push(filter);
        }
      });
      clearCircles();
      requestData();
    }

    function clearAll() {
      let allFilters = Array.from(document.getElementsByClassName("filter"));
      if (allFilters.length > 1) {
        allFilters.forEach((f) => {
          f.classList = "filter";
          let filter = f.id;
          if (activeFilters.includes(filter)) {
            let targetIndex = activeFilters.indexOf(filter);
            activeFilters.splice(targetIndex, 1);
          }
        });
      }
      clearCircles();
    }

    function mouseOver(event, d) {
      let name = document.getElementById("name");
      let rating = document.getElementById("rating");
      let neighborhood = document.getElementById("neighborhood");
      let review = document.getElementById("review");

      name.textContent = "Name: " + d.name;
      rating.textContent = "Rating: " + d.rating;
      neighborhood.textContent = "Neighborhood: " + d.neighborhood;
      review.textContent = "Sample Review: " + d.snippet_text;
    }

    function mouseOut(event, d) {
      let name = document.getElementById("name");
      let rating = document.getElementById("rating");
      let neighborhood = document.getElementById("neighborhood");
      let review = document.getElementById("review");

      name.textContent = "Name: ";
      rating.textContent = "Rating: ";
      neighborhood.textContent = "Neighborhood: ";
      review.textContent = "Sample Review: ";
    }

    requestData();
    makeFilters();
  </script>
</html>
